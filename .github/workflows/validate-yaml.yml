name: Validate Kubernetes YAML

on:
  push:
    branches: [main]
    paths:
      - 'Vocational_Test/**'
      - 'traefik/**'
      - '.github/workflows/validate-yaml.yml'
  pull_request:
    branches: [main]
    paths:
      - 'Vocational_Test/**'
      - 'traefik/**'

jobs:
  validate:
    name: Validate YAML
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout manifests
        uses: actions/checkout@v4

      - name: Install kubeval
        run: |
          mkdir -p /tmp/kubeval
          wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz -O - | tar xz -C /tmp/kubeval
          echo "/tmp/kubeval" >> $GITHUB_PATH

      - name: Validate Vocational_Test YAML syntax
        run: |
          if [ ! -d "Vocational_Test" ]; then
            echo "‚ö†Ô∏è  Vocational_Test/ directory not found, skipping validation"
            exit 0
          fi
          
          echo "Validating Vocational_Test/ manifests..."
          kubeval Vocational_Test/*.yaml --ignore-missing-schemas
          echo "‚úì Vocational_Test YAML validation passed"

      - name: Validate Traefik YAML syntax
        run: |
          if [ ! -d "traefik" ]; then
            echo "‚ö†Ô∏è  traefik/ directory not found, skipping validation"
            exit 0
          fi
          
          echo "Validating traefik/ manifests..."
          kubeval traefik/*.yaml --ignore-missing-schemas
          echo "‚úì Traefik YAML validation passed"

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint Vocational_Test YAML
        run: |
          if [ ! -d "Vocational_Test" ]; then
            echo "‚ö†Ô∏è  Vocational_Test/ directory not found, skipping linting"
            exit 0
          fi
          
          echo "Linting Vocational_Test/ YAML files..."
          yamllint -d relaxed Vocational_Test/
          echo "‚úì Vocational_Test YAML linting passed"

      - name: Lint Traefik YAML
        run: |
          if [ ! -d "traefik" ]; then
            echo "‚ö†Ô∏è  traefik/ directory not found, skipping linting"
            exit 0
          fi
          
          echo "Linting traefik/ YAML files..."
          yamllint -d relaxed traefik/
          echo "‚úì Traefik YAML linting passed"

      - name: Check for required files
        run: |
          echo "Checking required manifest files..."
          
          required_dirs=("Vocational_Test" "traefik")
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "‚úì Found directory: $dir"
            else
              echo "‚ö†Ô∏è  Directory not found: $dir (may be created later)"
            fi
          done
          
          echo "‚úì Directory check completed"

      - name: Validate manifest structure
        run: |
          echo "Validating manifest structure..."
          
          # Check for apiVersion and kind in all files
          for file in Vocational_Test/*.yaml traefik/*.yaml 2>/dev/null; do
            if [ -f "$file" ]; then
              if ! grep -q "^apiVersion:" "$file"; then
                echo "‚ùå Missing apiVersion in $file"
                exit 1
              fi
              if ! grep -q "^kind:" "$file"; then
                echo "‚ùå Missing kind in $file"
                exit 1
              fi
            fi
          done
          
          echo "‚úì All manifests have required fields"

      - name: Validation summary
        run: |
          echo "‚úÖ All YAML validations passed!"
          echo ""
          echo "Validated directories:"
          echo "  ‚Ä¢ Vocational_Test/"
          echo "  ‚Ä¢ traefik/"
          echo ""
          echo "Checks performed:"
          echo "  ‚úì kubeval syntax validation"
          echo "  ‚úì yamllint linting"
          echo "  ‚úì Required fields present (apiVersion, kind)"
          echo ""
          echo "Ready to deploy to K3S! üöÄ"
